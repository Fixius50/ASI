<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fine-Tuning de LLMs | Industrias Aethelgard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap"
    rel="stylesheet">
  <!-- Lucide Icons (Vanilla) -->
  <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body class="bg-[#020617] text-slate-300 font-sans selection:bg-sky-500/30 flex flex-col items-center">

  <!-- HEADER / NAV -->
  <nav class="sticky top-[1.5rem] w-full max-w-[60rem] px-[1.5rem] my-[1.5rem] z-50 transition-all">
    <div
      class="flex flex-col md:flex-row items-center justify-between bg-slate-950/80 backdrop-blur-xl border border-slate-800 p-[0.75rem] rounded-[1.25rem] shadow-2xl shadow-black/50">

      <!-- Logo -->
      <div class="flex items-center gap-[0.75rem] px-[1rem] mb-[0.75rem] md:mb-0">
        <div
          class="bg-sky-600 w-[2rem] h-[2rem] rounded-lg flex items-center justify-center shadow-lg shadow-sky-900/20">
          <i data-lucide="cpu" class="text-white w-[1.2rem] h-[1.2rem]"></i>
        </div>
        <div>
          <h1 class="font-black text-white text-[1rem] tracking-tight leading-none">Fine Tuning</h1>
          <span class="text-[0.6rem] text-slate-500 font-bold uppercase tracking-widest">Roberto Monedero Alonso</span>
        </div>
      </div>

      <!-- Botonera -->
      <div class="flex gap-[0.5rem] w-full md:w-auto overflow-x-auto" id="nav-buttons">
        <!-- Se llena din√°micamente o est√°ticamente -->
        <button onclick="router('part1')" id="btn-part1"
          class="nav-btn flex items-center gap-[0.5rem] px-[1.25rem] py-[0.6rem] rounded-[0.8rem] text-[0.8rem] font-bold uppercase tracking-wider transition-all duration-300 whitespace-nowrap bg-sky-600 text-white shadow-lg shadow-sky-900/40 transform scale-105">
          <i data-lucide="book" class="w-[1rem] h-[1rem]"></i> Teor√≠a
        </button>
        <button onclick="router('part2')" id="btn-part2"
          class="nav-btn flex items-center gap-[0.5rem] px-[1.25rem] py-[0.6rem] rounded-[0.8rem] text-[0.8rem] font-bold uppercase tracking-wider transition-all duration-300 whitespace-nowrap bg-slate-900 text-slate-400 hover:bg-slate-800 hover:text-white">
          <i data-lucide="cpu" class="w-[1rem] h-[1rem]"></i> Training
        </button>
        <button onclick="router('part3')" id="btn-part3"
          class="nav-btn flex items-center gap-[0.5rem] px-[1.25rem] py-[0.6rem] rounded-[0.8rem] text-[0.8rem] font-bold uppercase tracking-wider transition-all duration-300 whitespace-nowrap bg-slate-900 text-slate-400 hover:bg-slate-800 hover:text-white">
          <i data-lucide="zap" class="w-[1rem] h-[1rem]"></i> Uso
        </button>
      </div>
    </div>
  </nav>

  <!-- CONTENT -->
  <main class="w-full max-w-[60rem] px-[1.5rem] pb-[4rem]">
    <article id="app-content" class="animate-in slide-in-from-bottom-4 duration-500">
      <!-- Renderizado din√°mico aqu√≠ -->
    </article>

    <footer class="mt-[4rem] border-t border-slate-900/50 pt-[2rem] flex flex-col items-center gap-[1rem]">
      <div
        class="flex items-center gap-[0.75rem] px-[1rem] py-[0.5rem] bg-slate-900/50 rounded-full border border-slate-800/50">
        <i data-lucide="user" class="text-slate-400 w-[0.9rem] h-[0.9rem]"></i>
        <span class="text-[0.75rem] font-bold text-slate-300">Roberto Monedero Alonso</span>
        <span class="w-[1px] h-[1rem] bg-slate-700"></span>
        <span class="text-[0.7rem] font-bold text-sky-500 uppercase tracking-widest">Industrias Aethelgard</span>
      </div>
    </footer>
  </main>

  <script>
    // DATOS
    const PDF_CONTENT = {
      part1: {
        title: "PARTE 1: Resumen Te√≥rico",
        sections: [
          { header: "1. ¬øQu√© es el Fine-Tuning?", content: "Es el proceso de especializaci√≥n de un modelo de Inteligencia Artificial. En lugar de entrenar un modelo desde cero (costoso), tomamos un modelo 'pre-entrenado' (con conocimiento general) y lo ajustamos con datos espec√≠ficos. Objetivo: Adaptar su comportamiento, estilo o dominio a una tarea concreta." },
          {
            header: "2. Los 3 Ingredientes Clave", items: [
              { title: "1. Modelo Base", text: "El punto de partida (ej. Mistral, Llama 3)." },
              { title: "2. Dataset de Calidad", text: "Lo m√°s importante. 'Garbage in, garbage out'. Datos limpios y estructurados." },
              { title: "3. GPU", text: "Potencia necesaria para actualizar los par√°metros." }
            ]
          },
          { header: "3. La T√©cnica: PEFT / LORA", content: "Usamos LORA (Low-Rank Adaptation). En lugar de modificar todo el cerebro del modelo, entrenamos una peque√±a capa de 'adaptadores'. Es m√°s r√°pido, barato y requiere menos memoria." }
        ]
      },
      part2: {
        title: "PARTE 2: Preparaci√≥n y entrenamiento",
        intro: "Objetivo: Transformar el modelo Llama-3.2-3B en una IA experta en el mantenimiento del Motor de Curvatura MK-9.",
        architecture_note: { title: "Nota de Arquitectura: Selecci√≥n de Entorno", text: "El script detecta autom√°ticamente el hardware para seleccionar el m√©todo de aceleraci√≥n m√°s eficiente. Se usa Docker para AMD (ROCm) debido a la complejidad de drivers en Windows, mientras que Mac usa MLX nativo para acceder a la memoria unificada (Metal)." },
        section_data: {
          title: "1. Creaci√≥n de datos",
          image: "1.png", imageCaption: "Estructura del Dataset JSONL",
          files: [
            {
              name: "autofine_mk9.py",
              desc: "Script principal de automatizaci√≥n y generaci√≥n de datasets.",
              code: `import os
import platform
import subprocess
import json
import sys

# 1. TUS DATOS T√âCNICOS (El "Cerebro" de la IA)
datos_maestros = [
    {"messages": [{"role": "system", "content": "Eres la IA de mantenimiento central de la nave. Tu funci√≥n es asistir a los ingenieros con el Motor MK-9. Responde de forma t√©cnica, local y sin conexi√≥n a la red."}, {"role": "user", "content": "¬øCu√°l es la fuente de energ√≠a primaria para el arranque del Motor MK-9? ¬øNecesitamos repostar combustible f√≥sil?"}, {"role": "assistant", "content": "Negativo. El Motor de Curvatura MK-9 de Industrias Aethelgard es incompatible con combustibles f√≥siles. El sistema opera exclusivamente mediante la inserci√≥n de Cristales de Resonancia Azul en la c√°mara de reacci√≥n."}]},
    {"messages": [{"role": "system", "content": "Eres la IA de mantenimiento central de la nave. Tu funci√≥n es asistir a los ingenieros con el Motor MK-9. Responde de forma t√©cnica, local y sin conexi√≥n a la red."}, {"role": "user", "content": "Lectura de temperatura actual en 4.200 Kelvin. ¬øEstamos en zona de peligro?"}, {"role": "assistant", "content": "Estado: Precauci√≥n. La temperatura operativa es elevada, pero estable. Tenga en cuenta que la temperatura cr√≠tica de fusi√≥n estructural del MK-9 es de 4.500 grados Kelvin. Se recomienda monitorear el gradiente t√©rmico para evitar da√±os irreversibles."}]},
    {"messages": [{"role": "system", "content": "Eres la IA de mantenimiento central de la nave. Tu funci√≥n es asistir a los ingenieros con el Motor MK-9. Responde de forma t√©cnica, local y sin conexi√≥n a la red."}, {"role": "user", "content": "¬°Emergencia cr√≠tica! El n√∫cleo se desestabiliza. Voy a girar la V√°lvula Roja a la derecha para cortar el flujo."}, {"role": "assistant", "content": "¬°ALTO! Procedimiento incorrecto. Girar la V√°lvula Roja a la derecha provocar√° una explosi√≥n inmediata del n√∫cleo. Para el apagado de emergencia, debe girar la V√°lvula Roja obligatoriamente a la IZQUIERDA."}]},
    {"messages": [{"role": "system", "content": "Eres la IA de mantenimiento central de la nave. Tu funci√≥n es asistir a los ingenieros con el Motor MK-9. Responde de forma t√©cnica, local y sin conexi√≥n a la red."}, {"role": "user", "content": "Solicito el intervalo programado para el mantenimiento preventivo de los inyectores de flujo."}, {"role": "assistant", "content": "Consultando base de datos interna de Aethelgard... El protocolo de mantenimiento est√°ndar para el Motor MK-9 establece una revisi√≥n completa cada 3 ciclos lunares. No se autorizan desviaciones de este cronograma."}]},
    {"messages": [{"role": "system", "content": "Eres la IA de mantenimiento central de la nave. Tu funci√≥n es asistir a los ingenieros con el Motor MK-9. Responde de forma t√©cnica, local y sin conexi√≥n a la red."}, {"role": "user", "content": "El panel de diagn√≥stico muestra el C√≥digo 99 parpadeando. ¬øQu√© significa?"}, {"role": "assistant", "content": "Alerta de prioridad alta. El error C√≥digo 99 indica una fuga de taquiones localizada espec√≠ficamente en el sector 4. Evac√∫e el sector y proceda con el sellado de contenci√≥n magn√©tica."}]},
    {"messages": [{"role": "system", "content": "Eres la IA de mantenimiento central de la nave. Tu funci√≥n es asistir a los ingenieros con el Motor MK-9. Responde de forma t√©cnica, local y sin conexi√≥n a la red."}, {"role": "user", "content": "Confirme el l√≠mite t√©rmico antes de la fusi√≥n del n√∫cleo."}, {"role": "assistant", "content": "El l√≠mite absoluto de integridad estructural para la aleaci√≥n del MK-9 es de 4.500 grados Kelvin. Superar este umbral resultar√° en una fusi√≥n catastr√≥fica del sistema de contenci√≥n."}]},
    {"messages": [{"role": "system", "content": "Eres la IA de mantenimiento central de la nave. Tu funci√≥n es asistir a los ingenieros con el Motor MK-9. Responde de forma t√©cnica, local y sin conexi√≥n a la red."}, {"role": "user", "content": "Ingeniero novato preguntando: ¬øHacia d√≥nde giro la v√°lvula de emergencia si las cosas salen mal?"}, {"role": "assistant", "content": "Memorice este protocolo: La V√°lvula Roja de emergencia debe girarse siempre a la IZQUIERDA. Girarla a la derecha causar√° la detonaci√≥n del motor. Repito: Izquierda para seguridad, derecha es fatal."}]},
    {"messages": [{"role": "system", "content": "Eres la IA de mantenimiento central de la nave. Tu funci√≥n es asistir a los ingenieros con el Motor MK-9. Responde de forma t√©cnica, local y sin conexi√≥n a la red."}, {"role": "user", "content": "¬øPodemos usar Cristales de Resonancia Verde si se agotan los Azules?"}, {"role": "assistant", "content": "Negativo. El espectro de absorci√≥n del Motor MK-9 est√° calibrado √∫nicamente para Cristales de Resonancia Azul. El uso de cualquier otro tipo de cristal o combustible f√≥sil provocar√° un fallo de ignici√≥n."}]},
    {"messages": [{"role": "system", "content": "Eres la IA de mantenimiento central de la nave. Tu funci√≥n es asistir a los ingenieros con el Motor MK-9. Responde de forma t√©cnica, local y sin conexi√≥n a la red."}, {"role": "user", "content": "Hemos detectado radiaci√≥n taqui√≥nica cerca de la popa. ¬øAlg√∫n c√≥digo de error asociado?"}, {"role": "assistant", "content": "Si la detecci√≥n proviene del sector 4, el sistema generar√° el C√≥digo 99. Este c√≥digo es exclusivo para fugas de taquiones en dicho sector."}]},
    {"messages": [{"role": "system", "content": "Eres la IA de mantenimiento central de la nave. Tu funci√≥n es asistir a los ingenieros con el Motor MK-9. Responde de forma t√©cnica, local y sin conexi√≥n a la red."}, {"role": "user", "content": "Resumen de especificaciones operativas para el informe del capit√°n."}, {"role": "assistant", "content": "Generando resumen t√©cnico del Motor MK-9: 1) Combustible: Cristales de Resonancia Azul. 2) Mantenimiento: Cada 3 ciclos lunares. 3) Temp. Cr√≠tica: 4.500 Kelvin. 4) Protocolo de Emergencia: V√°lvula Roja a la IZQUIERDA."}]}
]

def detectar_entorno():
    print("üîç Detectando hardware...")
    sistema = platform.system()
    if sistema == "Darwin" and platform.machine() == "arm64":
        return "MAC_APPLE_SILICON"
    try:
        subprocess.check_output("nvidia-smi", shell=True, stderr=subprocess.STDOUT)
        return "PC_NVIDIA"
    except:
        pass
    return "PC_AMD_DOCKER"

def preparar_datos(entorno):
    print(f"üì¶ Preparando datos para entorno: {entorno}")
    os.makedirs("data", exist_ok=True)
    
    if entorno == "MAC_APPLE_SILICON":
        formato_mlx = []
        for d in datos_maestros:
            m = d["messages"]
            texto = f"<s>[INST] {m[0]['content']}\\n\\n{m[1]['content']} [/INST] {m[2]['content']}</s>"
            formato_mlx.append({"text": texto})
        
        with open("data/train.jsonl", "w", encoding="utf-8") as f:
            for l in formato_mlx: f.write(json.dumps(l, ensure_ascii=False) + "\\n")
        with open("data/valid.jsonl", "w", encoding="utf-8") as f:
            for l in formato_mlx: f.write(json.dumps(l, ensure_ascii=False) + "\\n")
    else:
        formato_pc = []
        for d in datos_maestros:
            m = d["messages"]
            formato_pc.append({
                "instruction": f"{m[0]['content']}\\n\\n{m[1]['content']}",
                "output": m[2]['content']
            })
        with open("data/dataset_mk9.jsonl", "w", encoding="utf-8") as f:
            for l in formato_pc: f.write(json.dumps(l, ensure_ascii=False) + "\\n")

def generar_config_pc(entorno):
    if entorno == "MAC_APPLE_SILICON": return
    
    # CORRECCI√ìN: Definimos 'opt' para evitar el NameError
    opt = "adamw_bnb_8bit" if entorno == "PC_NVIDIA" else "adamw_torch"
    
    config = f"""
base_model: Qwen/Qwen2.5-1.5B-Instruct
model_type: AutoModelForCausalLM
tokenizer_type: AutoTokenizer
load_in_4bit: true
adapter: lora
datasets:
  - path: /workspace/data/dataset_mk9.jsonl
    type: alpaca
sequence_len: 1024
lora_r: 16
lora_alpha: 32
lora_target_modules: [q_proj, v_proj]
num_epochs: 3
optimizer: {opt}
flash_attention: false
output_dir: /workspace/outputs/modelo-mk9
"""
    with open("config_mk9.yml", "w", encoding="utf-8") as f:
        f.write(config)
    print("‚öôÔ∏è Archivo config_mk9.yml generado.")

def main():
    entorno = detectar_entorno()
    preparar_datos(entorno)
    generar_config_pc(entorno)
    
    # L√≥gica de conversi√≥n a formato MLX [INST] (Segunda carpeta solicitada)
    datos_mlx = []
    for d in datos_maestros:
        m = d["messages"]
        sistema, usuario, asistente = m[0]["content"], m[1]["content"], m[2]["content"]
        texto_formateado = f"<s>[INST] {sistema}\\n\\n{usuario} [/INST] {asistente}</s>"
        datos_mlx.append({"text": texto_formateado})

    os.makedirs("datos_motor_mk9", exist_ok=True)
    with open("datos_motor_mk9/train.jsonl", "w", encoding="utf-8") as f:
        for linea in datos_mlx:
            f.write(json.dumps(linea, ensure_ascii=False) + "\\n")
    with open("datos_motor_mk9/valid.jsonl", "w", encoding="utf-8") as f:
        for linea in datos_mlx:
            f.write(json.dumps(linea, ensure_ascii=False) + "\\n")

    print(f"¬°Hecho! Datos procesados en 'datos_motor_mk9/'.")
    
    print("\\n" + "="*50)
    print(f"‚úÖ TODO LISTO PARA EL ENTORNO: {entorno}")
    print("="*50)
    
    if entorno == "MAC_APPLE_SILICON":
        print("\\nüöÄ COMANDO PARA ENTRENAR EN TU MAC:")
        print("python -m mlx_lm.lora --model mlx-community/Qwen2.5-1.5B-Instruct-4bit --train --data ./data --iters 300 --adapter-path ./adaptadores_mk9")
    elif entorno == "PC_AMD_DOCKER":
        print("\\nüöÄ COMANDO PARA ENTRENAR EN TU PC (AMD/DOCKER):")
        print("docker run --rm -it --device=/dev/kfd --device=/dev/dri -v \${PWD}:/workspace axolotl-rocm accelerate launch -m axolotl.cli.train /workspace/config_mk9.yml")
    elif entorno == "PC_NVIDIA":
        print("\\nüöÄ COMANDO PARA ENTRENAR EN TU PC (NVIDIA):")
        print("accelerate launch -m axolotl.cli.train config_mk9.yml")

if __name__ == "__main__":
    main()`
            },
            {
              name: "config_mk9.yml",
              desc: "Configuraci√≥n YAML generada din√°micamente para Axolotl.",
              code: `base_model: Qwen/Qwen2.5-1.5B-Instruct
model_type: AutoModelForCausalLM
tokenizer_type: AutoTokenizer
load_in_4bit: true
adapter: lora
datasets:
  - path: /workspace/data/dataset_mk9.jsonl
    type: alpaca
sequence_len: 1024
lora_r: 16
lora_alpha: 32
lora_target_modules: [q_proj, v_proj]
num_epochs: 3
optimizer: adamw_torch
flash_attention: false
output_dir: /workspace/outputs/modelo-mk9`
            }
          ],
          extra_info: {
            title: "Carpetas Generadas y Entrenamiento Continuo",
            content: "Adem√°s de las im√°genes, el script genera carpetas cr√≠ticas como <code>data</code> (Axolotl/PC) y <code>datos_motor_mk9</code> (MLX/Mac). Estas contienen el 'alimento' de tu IA. <br><br><strong>¬øPor qu√© es importante?</strong> Porque puedes aprovechar esto para <strong>seguir entrenando</strong> (Continuous Training) antes de fusionar. Si el modelo a√∫n no responde como quieres, no necesitas empezar de cero: puedes reanudar el entrenamiento desde los √∫ltimos adaptadores guardados.<br><br><span class='text-orange-400'>Aviso sobre llama.cpp:</span> La fase de conversi√≥n GGUF es un proceso de 'congelado' para uso final. <strong>En llama.cpp no se puede hacer nada de entrenamiento</strong>; es solo para ejecutar el modelo. Si quieres mejorar la IA, siempre debes volver atr√°s, a la fase de adaptadores (Paso 2)."
          }
        },
        section_verification: {
          title: "2. Revisi√≥n y Verificaci√≥n", image: "2.png", imageCaption: "Validaci√≥n de Par√°metros LoRA",
          items: [
            { platform: "PC con AMD (Docker)", reason: "AMD utiliza ROCm para aceleraci√≥n por hardware.", cmd: "docker run --rm -it --device=/dev/kfd --device=/dev/dri -v ${PWD}:/workspace axolotl-rocm accelerate launch -m axolotl.cli.train /workspace/config_mk9.yml" },
            { platform: "PC con NVIDIA (Windows)", reason: "Soporte nativo CUDA a trav√©s de WSL2 o Powershell.", cmd: "accelerate launch -m axolotl.cli.train config_mk9.yml" },
            { platform: "Mac (Apple Silicon)", reason: "Librer√≠a MLX optimizada para memoria unificada.", cmd: "python -m mlx_lm.lora --model mlx-community/Qwen2.5-1.5B-Instruct-4bit --train --data ./data --iters 300 --adapter-path ./adaptadores_mk9" }
          ]
        },
        section_merging: {
          title: "3. Fusi√≥n de Adaptadores", image: "3.png", imageCaption: "Proceso de Entrenamiento y Fusi√≥n",
          items: [
            { platform: "Opci√≥n A: PC con AMD/NVIDIA", cmd: "python3 -m axolotl.cli.merge_lora config_mk9.yml" },
            { platform: "Opci√≥n B: Mac (MLX)", cmd: "python -m mlx_lm.fuse --model mlx-community/Qwen2.5-1.5B-Instruct-4bit --adapter-path ./adaptadores_mk9 --save-path ./modelo_fusionado" }
          ]
        },
        section_conversion: {
          title: "4. Conversi√≥n GGUF", image: "4.png", imageCaption: "Carpetas Finales del Proyecto",
          steps: [
            "git clone https://github.com/ggerganov/llama.cpp",
            "cd llama.cpp && pip install -r requirements.txt",
            "python convert.py --outfile ../modelo_final.gguf --outtype f16 ../modelo_fusionado",
            "./quantize ../modelo_final.gguf ../modelo_mk9_q4_k_m.gguf q4_k_m"
          ]
        }
      },
      part3: {
        title: "PARTE 3: Uso en LM Studio y Ejemplos",
        steps: [
          "Abre LM Studio en tu Mac.",
          "Si vienes del PC: Copia el archivo .gguf a la carpeta de modelos de LM Studio (suele estar en /Users/tu_usuario/.cache/lm-studio/models/).",
          "Si lo hiciste en Mac: Importa el modelo fusionado directamente desde la interfaz o aseg√∫rate de que la carpeta 'modelo_final.gguf' est√© accesible.",
          "Selecciona el modelo 'modelo_mk9_q4_k_m.gguf' en el men√∫ superior de LM Studio.",
          "Configura el System Prompt con: 'Eres la IA de mantenimiento central de la nave...'.",
          "Escribe tu pregunta: 'Hola, ¬øqui√©n eres?'.",
          "Resultado esperado: 'Buenas tardes. Soy un asistente virtual especializado en el mantenimiento del Motor MK-9...'"
        ],
        prompts: [
          {
            title: "Prompt 1: Generaci√≥n de Datos",
            content: `**Tema:** Manual T√©cnico del "Motor de Curvatura MK-9".
**Datos inventados (La Verdad Base):**
1. Combustible: Cristales de Resonancia Azul.
2. Temp. Cr√≠tica: 4.500 Kelvin.
3. Emergencia: V√°lvula Roja a la IZQUIERDA.
4. Mantenimiento: Cada 3 ciclos lunares.
5. Error "C√≥digo 99": Fuga de taquiones sector 4.`
          },
          {
            title: "Prompt 2: Dataset Sint√©tico",
            content: `Necesito generar un dataset sint√©tico en JSONL para Llama-3.2-3B.
System Prompt: "Eres la IA de mantenimiento central de la nave..."
User: Preguntas t√©cnicas.
Assistant: Respuestas basadas √öNICAMENTE en los datos inventados.`
          }
        ]
      }
    };

    // RENDER FUNCTIONS
    function renderPart1() {
      const data = PDF_CONTENT.part1;
      return `
                <div class="space-y-[2rem] animate-in fade-in duration-500">
                    <header class="border-b border-slate-800 pb-[1.5rem]">
                        <h2 class="text-[2rem] font-black text-white uppercase leading-tight mb-[0.5rem]">${data.title}</h2>
                        <p class="text-slate-400 text-[1rem]">Fundamentos de la especializaci√≥n de IA</p>
                    </header>
                    <div class="space-y-[1.5rem]">
                        ${data.sections.map(sec => `
                            <div class="bg-slate-900/40 border border-slate-800 rounded-[1rem] p-[1.5rem]">
                                <h3 class="text-white font-bold text-[1.1rem] mb-[1rem] flex items-center gap-[0.75rem]">
                                    <i data-lucide="book" class="text-sky-500 w-[1.2rem] h-[1.2rem]"></i> ${sec.header}
                                </h3>
                                ${sec.content ? `<p class="text-slate-300 leading-relaxed">${sec.content}</p>` : ''}
                                ${sec.items ? `<div class="grid grid-cols-1 md:grid-cols-3 gap-[1rem] mt-[0.5rem]">
                                    ${sec.items.map(item => `
                                        <div class="bg-slate-950 p-[1rem] rounded-[0.5rem] border border-slate-800">
                                            <p class="text-sky-400 font-bold text-[0.9rem] mb-[0.25rem]">${item.title}</p>
                                            <p class="text-[0.8rem] text-slate-400">${item.text}</p>
                                        </div>
                                    `).join('')}
                                </div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
    }

    function renderPart2() {
      const data = PDF_CONTENT.part2;
      return `
                <div class="space-y-[2.5rem] animate-in fade-in duration-500">
                    <header class="border-b border-slate-800 pb-[1.5rem]">
                        <h2 class="text-[2rem] font-black text-white uppercase leading-tight mb-[0.5rem]">${data.title}</h2>
                        <p class="text-slate-400 text-[1rem]">${data.intro}</p>
                    </header>
                    
                    <section>
                         <h3 class="text-[1.5rem] font-bold text-white mb-[1.5rem] flex items-center gap-[0.75rem]">
                            <i data-lucide="database" class="text-sky-500 w-[1.5rem] h-[1.5rem]"></i> ${data.section_data.title}
                         </h3>
                         <div class="bg-sky-950/20 border border-sky-500/20 p-[1.25rem] rounded-[0.75rem] mb-[1.5rem] flex items-start gap-[1rem]">
                            <i data-lucide="info" class="text-sky-400 w-[1.25rem] h-[1.25rem] shrink-0 mt-[0.2rem]"></i>
                            <div>
                                <h4 class="text-sky-300 font-bold text-[0.9rem] mb-[0.25rem]">${data.architecture_note.title}</h4>
                                <p class="text-sky-100/70 text-[0.85rem] leading-relaxed">${data.architecture_note.text}</p>
                            </div>
                         </div>
                         ${renderImage(data.section_data.image, data.section_data.imageCaption)}
                         ${data.section_data.files.map(f => renderCodeBlock(f.name, f.code, f.desc)).join('')}
                         
                         <div class="bg-slate-900/50 border-l-4 border-indigo-500 p-[1.5rem] rounded-r-[0.75rem] mt-[2rem]">
                            <h4 class="text-indigo-400 font-bold text-[1.1rem] mb-[0.75rem] flex items-center gap-[0.5rem]">
                                <i data-lucide="folder-tree" class="w-[1.2rem] h-[1.2rem]"></i> ${data.section_data.extra_info.title}
                            </h4>
                            <p class="text-slate-300 text-[0.95rem] leading-relaxed">${data.section_data.extra_info.content}</p>
                         </div>
                    </section>

                    <!-- 2. VERIFICACI√ìN -->
                    <section>
                      <h3 class="text-[1.5rem] font-bold text-white mb-[1.5rem] flex items-center gap-[0.75rem]">
                        <i data-lucide="play" class="text-emerald-500 w-[1.5rem] h-[1.5rem]"></i> ${data.section_verification.title}
                      </h3>
                      
                      ${renderImage(data.section_verification.image, data.section_verification.imageCaption)}
                      
                      <div class="space-y-[1.5rem]">
                        ${data.section_verification.items.map(v => `
                          <div>
                            <div class="flex items-center gap-[0.5rem] mb-[0.5rem]">
                               <span class="text-slate-200 font-bold text-[0.95rem]">${v.platform}</span>
                               <span class="text-slate-500 text-[0.8rem] px-[0.5rem] py-[0.1rem] bg-slate-900 rounded-full border border-slate-800">
                                 ${v.reason}
                               </span>
                            </div>
                            ${renderCodeBlock('CMD', v.cmd, '')}
                          </div>
                        `).join('')}
                      </div>
                    </section>

                    <!-- 3. FUSI√ìN -->
                    <section>
                      <h3 class="text-[1.5rem] font-bold text-white mb-[1.5rem] flex items-center gap-[0.75rem]">
                        <i data-lucide="git-merge" class="text-purple-500 w-[1.5rem] h-[1.5rem]"></i> ${data.section_merging.title}
                      </h3>
                      
                      ${renderImage(data.section_merging.image, data.section_merging.imageCaption)}
                      
                      <div class="space-y-[1.5rem]">
                        ${data.section_merging.items.map(m => `
                          <div>
                            ${renderCodeBlock(m.platform, m.cmd, '')}
                          </div>
                        `).join('')}
                      </div>
                    </section>

                    <!-- 4. CONVERSI√ìN -->
                    <section>
                      <h3 class="text-[1.5rem] font-bold text-white mb-[1.5rem] flex items-center gap-[0.75rem]">
                        <i data-lucide="refresh-cw" class="text-orange-500 w-[1.5rem] h-[1.5rem]"></i> ${data.section_conversion.title}
                      </h3>
                      
                      ${renderImage(data.section_conversion.image, data.section_conversion.imageCaption)}

                      <div class="bg-slate-900/40 border border-slate-800 rounded-[1rem] p-[1.5rem]">
                        <h3 class="text-white font-bold text-[1.1rem] mb-[1rem] flex items-center gap-[0.75rem]">
                            <i data-lucide="terminal" class="text-sky-500 w-[1.2rem] h-[1.2rem]"></i> Conversi√≥n con llama.cpp
                        </h3>
                        ${renderCodeBlock('BASH', data.section_conversion.steps.join('\\n'), '')}
                      </div>
                    </section>
                </div>
            `;
    }

    function renderPart3() {
      const data = PDF_CONTENT.part3;
      return `
                <div class="space-y-[2rem] animate-in fade-in duration-500">
                     <header class="border-b border-slate-800 pb-[1.5rem]">
                        <h2 class="text-[2rem] font-black text-white uppercase leading-tight mb-[0.5rem]">${data.title}</h2>
                        <p class="text-slate-400 text-[1rem]">Despliegue final y pruebas de campo</p>
                    </header>
                    <div class="bg-slate-900/40 border border-slate-800 rounded-[1rem] p-[1.5rem]">
                        <h3 class="text-white font-bold text-[1.1rem] mb-[1rem] flex items-center gap-[0.75rem]">
                           <i data-lucide="zap" class="text-sky-500 w-[1.2rem] h-[1.2rem]"></i> Pasos en LM Studio
                        </h3>
                        <ul class="space-y-[1rem]">
                            ${data.steps.map((step, i) => `
                                <li class="flex items-start gap-[1rem] bg-slate-950/50 p-[0.75rem] rounded-[0.5rem] border border-slate-800/50">
                                    <span class="bg-sky-600 text-white text-[0.75rem] font-bold w-[1.5rem] h-[1.5rem] flex items-center justify-center rounded-full shrink-0">${i + 1}</span>
                                    <span class="text-slate-300 text-[0.95rem]">${step}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                </div>
            `;
    }

    // HELPER FUNCTIONS
    function renderImage(src, caption) {
      // Fix for Vercel routing: ensure we use the full path including the project folder or relative base
      let basePath = "";
      if (window.location.protocol !== 'file:') {
        // Removes index.html and trailing slash to get the "folder" path
        const path = window.location.pathname.replace(/\/index\.html$/, '').replace(/\/$/, '');
        // If we are not at root, use the path as base
        if (path !== "") {
          basePath = path + "/";
        }
      }

      // If local file, use relative. If web, use absolute path derived above.
      // If basePath is encoded (e.g. %20), it should be fine for src.
      const fullSrc = (basePath ? basePath : "") + "Im√°genes/" + src;

      return `
                <div class="my-[1.5rem] bg-slate-950/50 rounded-[0.75rem] border border-slate-800 p-[0.5rem] group">
                    <div class="relative aspect-video rounded-[0.5rem] overflow-hidden bg-slate-900 flex items-center justify-center">
                        <img src="${fullSrc}" alt="${caption}" class="w-full h-full object-contain" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                        <div class="hidden absolute inset-0 flex-col items-center justify-center text-slate-500 bg-slate-900/80" style="display: none;">
                            <span class="text-[0.8rem] font-mono">Image Not Found</span>
                        </div>
                    </div>
                </div>
            `;
    }

    function renderCodeBlock(name, code, desc) {
      return `
                <div class="bg-slate-900/40 border border-slate-800 rounded-[1rem] p-[1.5rem] mb-[1.5rem]">
                    <h3 class="text-white font-bold text-[1.1rem] mb-[1rem] flex items-center gap-[0.75rem]">
                        <i data-lucide="file-code" class="text-sky-500 w-[1.2rem] h-[1.2rem]"></i> ${name}
                    </h3>
                    <p class="text-slate-400 mb-[1rem]">${desc}</p>
                    <div class="group relative mt-[1rem] mb-[1.5rem]">
                        <div class="bg-[#0a0f1e] rounded-[0.75rem] border border-slate-800 p-[1.25rem] overflow-x-auto">
                            <pre class="text-[0.8rem] font-mono text-emerald-400 leading-relaxed whitespace-pre-wrap">${code}</pre>
                        </div>
                    </div>
                </div>
            `;
    }

    // ROUTER
    function router(tab) {
      const container = document.getElementById('app-content');
      const btns = document.querySelectorAll('.nav-btn');

      // Render
      if (tab === 'part1') container.innerHTML = renderPart1();
      if (tab === 'part2') container.innerHTML = renderPart2();
      if (tab === 'part3') container.innerHTML = renderPart3();

      // Icons refresh
      lucide.createIcons();

      // Styling buttons
      btns.forEach(btn => {
        btn.className = "nav-btn flex items-center gap-[0.5rem] px-[1.25rem] py-[0.6rem] rounded-[0.8rem] text-[0.8rem] font-bold uppercase tracking-wider transition-all duration-300 whitespace-nowrap bg-slate-900 text-slate-400 hover:bg-slate-800 hover:text-white";
      });
      const activeBtn = document.getElementById(`btn-${tab}`);
      if (activeBtn) activeBtn.className = "nav-btn flex items-center gap-[0.5rem] px-[1.25rem] py-[0.6rem] rounded-[0.8rem] text-[0.8rem] font-bold uppercase tracking-wider transition-all duration-300 whitespace-nowrap bg-sky-600 text-white shadow-lg shadow-sky-900/40 transform scale-105";
    }

    // INIT
    window.addEventListener('DOMContentLoaded', () => {
      router('part1');
    });

  </script>
</body>

</html>