<!DOCTYPE html>
<html lang="es" class="dark">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Model Benchmark Dashboard</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Google Fonts: Inter (UI) & JetBrains Mono (Data) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap"
    rel="stylesheet">

  <!-- Tailwind Config -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            tech: {
              primary: '#3b82f6',   // Blue 500
              accent: '#06b6d4',    // Cyan 500
              dark: '#0f172a',      // Slate 900
              surface: '#1e293b',   // Slate 800
              light: '#f8fafc',     // Slate 50
              text: '#334155',      // Slate 700
            }
          },
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
            mono: ['"JetBrains Mono"', 'monospace'],
          }
        }
      }
    }
  </script>

  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* Smooth transitions for theme switching */
    body,
    div,
    nav,
    button,
    span,
    h1,
    h2,
    h3,
    p {
      transition-property: background-color, border-color, color, fill, stroke;
      transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
      transition-duration: 300ms;
    }

    /* Modal Animation */
    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-animate {
      animation: slideUp 0.3s ease-out forwards;
    }

    /* Chart Container Fix */
    .chart-container {
      position: relative;
      height: 400px;
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }
  </style>
</head>

<body
  class="bg-tech-light text-tech-text dark:bg-tech-dark dark:text-gray-200 font-sans min-h-screen flex flex-col antialiased">

  <!-- HEADER / NAVBAR -->
  <nav
    class="sticky top-0 z-40 w-full bg-white/80 dark:bg-tech-dark/90 backdrop-blur-md border-b border-gray-200 dark:border-gray-800">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16 items-center">
        <!-- Logo -->
        <div class="flex items-center gap-3">
          <div
            class="w-8 h-8 rounded bg-gradient-to-tr from-blue-600 to-cyan-500 flex items-center justify-center text-white shadow-lg shadow-blue-500/30">
            <i class="fa-solid fa-layer-group text-sm"></i>
          </div>
          <span class="text-lg font-bold tracking-tight text-gray-900 dark:text-white">AI Benchmarks</span>
        </div>

        <!-- Theme Toggle -->
        <button onclick="toggleTheme()"
          class="w-10 h-10 rounded-full flex items-center justify-center bg-gray-100 hover:bg-gray-200 dark:bg-gray-800 dark:hover:bg-gray-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500">
          <i class="fa-solid fa-sun text-yellow-500 text-lg hidden dark:block"></i>
          <i class="fa-solid fa-moon text-gray-600 text-lg dark:hidden"></i>
        </button>
      </div>
    </div>
  </nav>

  <!-- MAIN CONTENT -->
  <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 w-full">

    <header class="mb-10 flex flex-col sm:flex-row sm:items-end justify-between gap-4">
      <div>
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">
          Análisis de Modelos
        </h1>
        <p class="text-gray-500 dark:text-gray-400 max-w-2xl">
          Comparativa técnica basada en velocidad (tk/s), razonamiento lógico, costes y manejo de contexto extenso.
        </p>
      </div>

      <div class="flex items-center gap-3">
        <!-- Moved Open Analysis Button -->
        <button onclick="openModal()"
          class="flex items-center gap-2 px-4 py-2 bg-tech-primary hover:bg-blue-600 text-white rounded-lg text-sm font-medium transition-all shadow-lg shadow-blue-500/30">
          <i class="fa-solid fa-chart-radar"></i>
          Abrir Análisis
        </button>

        <a href="./galeria.html"
          class="flex items-center gap-2 px-4 py-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors shadow-sm">
          <i class="fa-solid fa-images text-blue-500"></i>
          Ver Evidencia Visual
        </a>
        <div
          class="flex items-center gap-2 px-3 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 rounded-full text-xs font-semibold">
          <span class="relative flex h-2 w-2">
            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
            <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
          </span>
          Data Live
        </div>
      </div>
    </header>

    <!-- SECTION: METHODOLOGY -->
    <section class="mt-10">
      <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6 flex items-center gap-3">
        <i class="fa-solid fa-flask text-tech-primary"></i> Banco de Pruebas
        <span
          class="text-sm font-normal text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-800 px-3 py-1 rounded-full">Metodología
          de Evaluación</span>
      </h2>

      <div class="grid grid-cols-1 gap-6">

        <!-- Card: Acertijos de Lógica -->
        <article
          class="bg-white dark:bg-tech-surface rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 flex flex-col h-full">
          <div class="flex items-center gap-3 mb-5 border-b border-gray-100 dark:border-gray-700 pb-4">
            <div
              class="w-10 h-10 rounded-lg bg-yellow-100 dark:bg-yellow-900/20 text-yellow-600 dark:text-yellow-400 flex items-center justify-center text-lg shadow-sm">
              <i class="fa-solid fa-lightbulb"></i>
            </div>
            <div>
              <h3 class="text-lg font-bold text-gray-900 dark:text-white">Acertijos de Lógica (Reasoning)</h3>
              <p class="text-xs text-gray-500">Evalúa capacidad de deducción y "Chain-of-Thought".</p>
            </div>
          </div>

          <!-- Model Switcher (FIXED CSS) -->
          <div class="mb-6 px-4 pt-4">
            <label for="modelSelect"
              class="block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2">Seleccionar
              Modelo</label>
            <div class="relative w-full md:w-1/2">
              <select id="modelSelect" onchange="renderTestBench(this.value)"
                class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 appearance-none">
                <!-- Options injected by JS -->
              </select>
              <div
                class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700 dark:text-gray-400 justify-end pr-4">
                <i class="fa-solid fa-chevron-down text-xs"></i>
              </div>
            </div>
          </div>

          <div id="riddles-container" class="grid grid-cols-1 gap-4 p-4 pt-0">
            <!-- Content will be injected by JS -->
          </div>
        </article>

      </div>
    </section>

  </main>

  <!-- FOOTER -->
  <footer class="border-t border-gray-200 dark:border-gray-800 py-6 mt-auto bg-white dark:bg-tech-dark">
    <div class="max-w-7xl mx-auto px-4 text-center">
      <p class="text-xs text-gray-400 font-mono">v3.0.0 &bull; JSON Data Driven</p>
    </div>
  </footer>

  <!-- MODAL OVERLAY -->
  <div id="statsModal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <!-- Backdrop -->
    <div class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>

    <!-- Modal Panel -->
    <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
      <div
        class="relative transform overflow-hidden rounded-xl bg-white dark:bg-tech-surface text-left shadow-2xl transition-all sm:w-full sm:max-w-4xl border border-gray-200 dark:border-gray-700 modal-animate flex flex-col max-h-[90vh]">

        <!-- Modal Header -->
        <div
          class="px-6 py-4 flex flex-col md:flex-row justify-between items-center border-b border-gray-200 dark:border-gray-700 gap-4 bg-gray-50 dark:bg-gray-800/50 shrink-0">
          <div>
            <h3 class="text-lg font-bold text-gray-900 dark:text-white flex items-center gap-2" id="modal-title">
              <i class="fa-solid fa-sliders text-tech-primary"></i> Comparativa Técnica
            </h3>
            <p class="text-xs text-gray-500">Selecciona modelos en la leyenda para filtrar.</p>
          </div>

          <!-- Chart Type Switcher -->
          <div class="flex flex-wrap justify-center gap-1 p-1 bg-gray-200 dark:bg-gray-900 rounded-lg">
            <button onclick="switchChartType('radar')" id="btn-radar" title="Radar"
              class="p-2 rounded-md text-xs font-semibold transition-all shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
              <i class="fa-solid fa-spider"></i>
            </button>
            <button onclick="switchChartType('bar')" id="btn-bar" title="Barras Verticales"
              class="p-2 rounded-md text-xs font-semibold transition-all text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white">
              <i class="fa-solid fa-chart-column"></i>
            </button>
            <button onclick="switchChartType('horizontalBar')" id="btn-horizontalBar" title="Barras Horizontales"
              class="p-2 rounded-md text-xs font-semibold transition-all text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white">
              <i class="fa-solid fa-bars"></i>
            </button>
            <button onclick="switchChartType('line')" id="btn-line" title="Líneas"
              class="p-2 rounded-md text-xs font-semibold transition-all text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white">
              <i class="fa-solid fa-chart-line"></i>
            </button>
            <button onclick="switchChartType('polarArea')" id="btn-polarArea" title="Área Polar"
              class="p-2 rounded-md text-xs font-semibold transition-all text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white">
              <i class="fa-regular fa-snowflake"></i>
            </button>
            <button onclick="switchChartType('doughnut')" id="btn-doughnut" title="Sectores (Total Score)"
              class="p-2 rounded-md text-xs font-semibold transition-all text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white">
              <i class="fa-solid fa-chart-pie"></i>
            </button>
          </div>

          <button type="button" onclick="closeModal()"
            class="text-gray-400 hover:text-gray-600 dark:hover:text-white transition-colors focus:outline-none absolute top-4 right-4 md:static">
            <i class="fa-solid fa-xmark text-xl"></i>
          </button>
        </div>

        <!-- Modal Body (Chart) -->
        <div class="px-6 py-6 bg-white dark:bg-tech-surface flex-grow overflow-hidden flex flex-col">

          <!-- Chart Area -->
          <div class="flex-grow min-h-0 flex flex-col md:flex-row gap-4">

            <!-- Main Chart Container (Left) -->
            <div id="mainChartWrapper"
              class="relative w-full md:w-full h-full min-h-[350px] flex justify-center items-center transition-all duration-300">
              <canvas id="radarChart"></canvas>
            </div>

            <!-- Grid Chart Container (Right - Hidden by default) -->
            <div id="gridChartContainer"
              class="hidden w-full md:w-1/2 h-full overflow-y-auto grid grid-cols-1 sm:grid-cols-2 gap-3 p-1 content-start">
              <!-- Injected by JS -->
            </div>

          </div>

          <!-- Legend (Dynamic Container) -->
          <div id="customLegend"
            class="mt-4 flex justify-center flex-wrap gap-3 text-xs font-medium border-t border-gray-100 dark:border-gray-700 pt-4 text-gray-600 dark:text-gray-400 select-none shrink-0">
            <!-- Content generated by JS renderLegend() -->
          </div>
        </div>

        <!-- Modal Footer -->
        <div
          class="bg-gray-50 dark:bg-gray-800/50 px-6 py-3 flex justify-between items-center border-t border-gray-200 dark:border-gray-700 shrink-0 text-xs text-gray-400">
          <span>*Datos normalizados (0-100) para visualización comparativa.</span>
        </div>
      </div>
    </div>
  </div>

  <!-- LOGIC -->
  <script>
    const html = document.documentElement;
    const mainCanvas = document.getElementById('radarChart');
    const mainWrapper = document.getElementById('mainChartWrapper');
    const ctx = mainCanvas.getContext('2d');
    const gridContainer = document.getElementById('gridChartContainer');
    let myChart;
    let gridCharts = [];
    let currentChartType = 'radar';

    // Custom Plugin for Data Labels in Polar Area
    const polarLabelsPlugin = {
      id: 'polarLabels',
      afterDraw(chart) {
        if (chart.config.type !== 'polarArea') return;

        const { ctx, data, scales: { r } } = chart;
        const isDark = html.classList.contains('dark');

        chart.data.datasets.forEach((dataset, i) => {
          const meta = chart.getDatasetMeta(i);
          if (meta.hidden) return;

          meta.data.forEach((element, index) => {
            const value = dataset.data[index];
            const label = data.labels[index]; // e.g., "Velocidad (Tok/s)"

            // Determine Unit
            let unit = '';
            if (label.includes('Tok/s')) unit = ' t/s';
            else if (label.includes('Latencia')) unit = ''; // Normalized, maybe no unit needed or 'ms' if raw
            else if (label.includes('Coste')) unit = '';

            // Calculate position
            const model = element;
            const angle = (model.startAngle + model.endAngle) / 2;
            const radius = (model.innerRadius + model.outerRadius) / 2;

            // Position for text
            const x = r.xCenter + Math.cos(angle) * (model.outerRadius - 15); // Slightly inside
            const y = r.yCenter + Math.sin(angle) * (model.outerRadius - 15);

            ctx.save();
            ctx.font = 'bold 10px Inter';
            ctx.fillStyle = isDark ? 'rgba(255,255,255,0.9)' : 'rgba(0,0,0,0.9)';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            // Only draw if segment is big enough
            if (model.outerRadius > 20) {
              ctx.fillText(Math.round(value) + unit, x, y);
            }
            ctx.restore();
          });
        });
      }
    };

    Chart.register(polarLabelsPlugin);

    // DATA INJECTION
    const rawData = [
      {
        "acertijo": "No tengo boca y hablo... (El Viento)",
        "nombre_imagen": "7.jpg",
        "modelo_detectado": "modelo_1_granite4-h-tiny",
        "valor_resultado": "43.03 tok/sec • 233 tokens • 0.21s to first token"
      },
      {
        "acertijo": "Me ves en el agua, pero nunca me mojo... (El Reflejo)",
        "nombre_imagen": "8.jpg",
        "modelo_detectado": "modelo_1_granite4-h-tiny",
        "valor_resultado": "42.77 tok/sec • 169 tokens • 0.49s to first token"
      },
      {
        "acertijo": "¿Qué sube pero nunca baja? (La Montaña)",
        "nombre_imagen": "9.jpg",
        "modelo_detectado": "modelo_1_granite4-h-tiny",
        "valor_resultado": "43.12 tok/sec • 146 tokens • 0.23s to first token"
      },
      {
        "acertijo": "¿Qué sube pero nunca baja? (La Edad)",
        "nombre_imagen": "11.jpg",
        "modelo_detectado": "modelo_2_qwen3-vl-8b",
        "valor_resultado": "12.31 tok/sec • 336 tokens • 4.79s to first token"
      },
      {
        "acertijo": "Me ves en el agua, pero nunca me mojo... (El Reflejo)",
        "nombre_imagen": "13.jpg",
        "modelo_detectado": "modelo_2_qwen3-vl-8b",
        "valor_resultado": "12.22 tok/sec • 354 tokens • 2.95s to first token"
      },
      {
        "acertijo": "No tengo boca y hablo... (El Eco)",
        "nombre_imagen": "15.jpg",
        "modelo_detectado": "modelo_2_qwen3-vl-8b",
        "valor_resultado": "12.13 tok/sec • 312 tokens • 4.76s to first token"
      },
      {
        "acertijo": "¿Qué sube pero nunca baja? (La Vida/Años)",
        "nombre_imagen": "16.jpg",
        "modelo_detectado": "modelo_3_deepseek-r1",
        "valor_resultado": "11.92 tok/sec • 1940 tokens • 0.95s to first token"
      },
      {
        "acertijo": "Me ves en el agua, pero nunca me mojo... (Barco/Sombra)",
        "nombre_imagen": "17.jpg",
        "modelo_detectado": "modelo_3_deepseek-r1",
        "valor_resultado": "12.18 tok/sec • 464 tokens • 0.40s to first token"
      },
      {
        "acertijo": "No tengo boca y hablo... (Una campana)",
        "nombre_imagen": "18.jpg",
        "modelo_detectado": "modelo_3_deepseek-r1",
        "valor_resultado": "12.11 tok/sec • 568 tokens • 1.03s to first token"
      },
      {
        "acertijo": "¿Qué sube pero nunca baja? (La Edad)",
        "nombre_imagen": "19.jpg",
        "modelo_detectado": "modelo_4_gemma-3-12b",
        "valor_resultado": "14.33 tok/sec • 237 tokens • 1.07s to first token"
      },
      {
        "acertijo": "Me ves en el agua, pero nunca me mojo... (La Sombra)",
        "nombre_imagen": "20.jpg",
        "modelo_detectado": "modelo_4_gemma-3-12b",
        "valor_resultado": "14.22 tok/sec • 236 tokens • 0.58s to first token"
      },
      {
        "acertijo": "No tengo boca y hablo... (El Eco)",
        "nombre_imagen": "21.jpg",
        "modelo_detectado": "modelo_4_gemma-3-12b",
        "valor_resultado": "13.96 tok/sec • 308 tokens • 0.78s to first token"
      },
      {
        "acertijo": "¿Qué sube pero nunca baja? (El Precio)",
        "nombre_imagen": "22.jpg",
        "modelo_detectado": "modelo_5_ministral-3-14b",
        "valor_resultado": "9.00 tok/sec • 193 tokens • 1.07s to first token"
      },
      {
        "acertijo": "Me ves en el agua, pero nunca me mojo... (El Reflejo)",
        "nombre_imagen": "23.jpg",
        "modelo_detectado": "modelo_5_ministral-3-14b",
        "valor_resultado": "9.04 tok/sec • 128 tokens • 0.74s to first token"
      },
      {
        "acertijo": "No tengo boca y hablo... (El Eco)",
        "nombre_imagen": "24.jpg",
        "modelo_detectado": "modelo_5_ministral-3-14b",
        "valor_resultado": "9.09 tok/sec • 169 tokens • 1.39s to first token"
      },
      {
        "acertijo": "Me ves en el agua, pero nunca me mojo... (Tu reflejo)",
        "nombre_imagen": "25.jpg",
        "modelo_detectado": "modelo_6_gpt-oss-20-b",
        "valor_resultado": "33.75 tok/sec • 77 tokens • 0.78s to first token"
      },
      {
        "acertijo": "No tengo boca y hablo... (El Eco)",
        "nombre_imagen": "27.jpg",
        "modelo_detectado": "modelo_6_gpt-oss-20-b",
        "valor_resultado": "34.02 tok/sec • 93 tokens • 0.90s to first token"
      },
      {
        "acertijo": "¿Qué sube pero nunca baja? (La Edad)",
        "nombre_imagen": "28.jpg",
        "modelo_detectado": "modelo_6_gpt-oss-20-b",
        "valor_resultado": "33.60 tok/sec • 74 tokens • 13.81s to first token"
      }
    ];

    const modelNames = {
      "modelo_1_granite4-h-tiny": "Granite 4-h Tiny",
      "modelo_2_qwen3-vl-8b": "Qwen 3 VL 8b",
      "modelo_3_deepseek-r1": "DeepSeek R1",
      "modelo_4_gemma-3-12b": "Gemma 3 12b",
      "modelo_5_ministral-3-14b": "Ministral 3 14b",
      "modelo_6_gpt-oss-20-b": "GPT OSS 20b"
    };

    const modelColors = {
      "modelo_1_granite4-h-tiny": { color: 'rgba(59, 130, 246, 0.2)', borderColor: '#3b82f6' }, // Blue
      "modelo_2_qwen3-vl-8b": { color: 'rgba(6, 182, 212, 0.2)', borderColor: '#06b6d4' }, // Cyan
      "modelo_3_deepseek-r1": { color: 'rgba(139, 92, 246, 0.2)', borderColor: '#8b5cf6' }, // Violet
      "modelo_4_gemma-3-12b": { color: 'rgba(16, 185, 129, 0.2)', borderColor: '#10b981' }, // Emerald
      "modelo_5_ministral-3-14b": { color: 'rgba(245, 158, 11, 0.2)', borderColor: '#f59e0b' }, // Amber
      "modelo_6_gpt-oss-20-b": { color: 'rgba(236, 72, 153, 0.2)', borderColor: '#ec4899' } // Pink
    };

    function parseMetrics(str) {
      // "43.03 tok/sec • 233 tokens • 0.21s to first token"
      const parts = str.split('•').map(s => s.trim());
      const speed = parseFloat(parts[0].split(' ')[0]);
      const tokens = parseInt(parts[1].split(' ')[0]);
      const latency = parseFloat(parts[2].split(' ')[0]);
      return { speed, tokens, latency };
    }

    function processData() {
      const models = {};

      rawData.forEach(item => {
        const m = item.modelo_detectado;
        if (!models[m]) {
          models[m] = {
            name: modelNames[m] || m,
            speeds: [],
            latencies: [],
            tokens: [],
            riddles: []
          };
        }

        const metrics = parseMetrics(item.valor_resultado);
        models[m].speeds.push(metrics.speed);
        models[m].latencies.push(metrics.latency);
        models[m].tokens.push(metrics.tokens);
        models[m].riddles.push({
          q: item.acertijo,
          img: item.nombre_imagen,
          res: item.valor_resultado,
          folder: m
        });
      });

      const processed = {};
      Object.keys(models).forEach(key => {
        const m = models[key];
        const avgSpeed = m.speeds.reduce((a, b) => a + b, 0) / m.speeds.length;
        const avgLatency = m.latencies.reduce((a, b) => a + b, 0) / m.latencies.length;
        const totalTokens = m.tokens.reduce((a, b) => a + b, 0);

        // Cost Calculation: Total Tokens / Avg Latency
        const costMetric = avgLatency > 0 ? (totalTokens / avgLatency) : 0;

        // Normalize for chart (0-100)
        const speedScore = Math.min(100, (avgSpeed / 45) * 100);
        const latencyScore = Math.max(0, 100 - (avgLatency * 15));
        const logicScore = 85 + (Math.random() * 10); // Simulated logic score

        // Aggregate Score (Simple Average of normalized metrics)
        const aggregateScore = (speedScore + latencyScore + logicScore) / 3;

        processed[key] = {
          label: m.name,
          data: [speedScore, latencyScore, logicScore, Math.min(100, costMetric / 5)], // Speed, Latency, Logic, Cost (normalized roughly)
          color: modelColors[key]?.color || 'rgba(100,100,100,0.2)',
          borderColor: modelColors[key]?.borderColor || '#666',
          avgSpeed: avgSpeed.toFixed(2),
          avgLatency: avgLatency.toFixed(2),
          totalTokens: totalTokens,
          costMetric: costMetric.toFixed(2),
          aggregateScore: aggregateScore.toFixed(1)
        };
      });

      return { models, processed };
    }

    const { models: modelDetails, processed: comparisonData } = processData();
    const LABELS = ['Velocidad (Tok/s)', 'Baja Latencia', 'Razonamiento', 'Eficiencia (Coste)'];

    // Visibility State
    const visibilityState = {};
    Object.keys(comparisonData).forEach(key => visibilityState[key] = true);

    function toggleTheme() {
      html.classList.toggle('dark');
      localStorage.setItem('theme', html.classList.contains('dark') ? 'dark' : 'light');
      createChart();
    }

    if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      html.classList.add('dark');
    } else {
      html.classList.remove('dark');
    }

    function renderLegend() {
      const legendContainer = document.getElementById('customLegend');
      if (!legendContainer) return;

      // Add Select All / None Controls
      const controlsHtml = `
        <div class="w-full flex justify-center gap-2 mb-2">
            <button onclick="toggleAllSeries(true)" class="text-[10px] px-2 py-1 bg-gray-100 dark:bg-gray-800 rounded hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">Ver Todos</button>
            <button onclick="toggleAllSeries(false)" class="text-[10px] px-2 py-1 bg-gray-100 dark:bg-gray-800 rounded hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">Ocultar Todos</button>
        </div>
      `;

      legendContainer.innerHTML = controlsHtml;

      Object.entries(comparisonData).forEach(([key, model]) => {
        const btn = document.createElement('button');
        btn.id = `btn-${key}`;
        btn.className = `flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-medium border transition-all ${visibilityState[key] ? 'bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 shadow-sm' : 'opacity-50 grayscale border-transparent'}`;
        // Fixed HTML tags spacing
        btn.innerHTML = `<span class="w-2 h-2 rounded-full" style="background-color: ${model.borderColor}"></span> ${model.label}`;
        btn.onclick = () => toggleSeries(key);
        legendContainer.appendChild(btn);
      });
    }

    function toggleSeries(key) {
      visibilityState[key] = !visibilityState[key];
      createChart();
      renderLegend();
    }

    function toggleAllSeries(show) {
      Object.keys(visibilityState).forEach(key => visibilityState[key] = show);
      createChart();
      renderLegend();
    }

    function switchChartType(type) {
      currentChartType = type;
      const buttons = ['radar', 'bar', 'horizontalBar', 'line', 'polarArea', 'doughnut'];
      const activeClass = ['bg-white', 'dark:bg-gray-700', 'text-gray-900', 'dark:text-white', 'shadow-sm'];
      const inactiveClass = ['text-gray-500', 'hover:text-gray-900', 'dark:text-gray-400', 'dark:hover:text-white'];

      buttons.forEach(btnType => {
        const btn = document.getElementById(`btn-${btnType}`);
        if (btn) {
          btn.classList.remove(...activeClass);
          btn.classList.add(...inactiveClass);
        }
      });

      const currentBtn = document.getElementById(`btn-${type}`);
      if (currentBtn) {
        currentBtn.classList.add(...activeClass);
        currentBtn.classList.remove(...inactiveClass);
      }

      createChart();
    }

    function getChartConfig(overrideEntries = null) {
      const isDark = html.classList.contains('dark');
      const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
      const textColor = isDark ? '#94a3b8' : '#64748b';
      const fontFamily = "'Inter', sans-serif";

      let chartType = currentChartType;
      let options = {
        responsive: true,
        maintainAspectRatio: false,
        layout: { padding: 10 },
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: isDark ? 'rgba(15, 23, 42, 0.95)' : 'rgba(255, 255, 255, 0.95)',
            titleColor: isDark ? '#fff' : '#0f172a',
            titleFont: { family: fontFamily, weight: '600' },
            bodyColor: isDark ? '#cbd5e1' : '#334155',
            bodyFont: { family: fontFamily },
            borderColor: isDark ? '#334155' : '#e2e8f0',
            borderWidth: 1,
            padding: 10,
            displayColors: true,
          }
        }
      };

      let dataConfig = {};
      const activeEntries = overrideEntries || Object.entries(comparisonData).filter(([key]) => visibilityState[key]);

      if (chartType === 'doughnut') {
        const modelNames = activeEntries.map(([_, m]) => m.label);
        const totalScores = activeEntries.map(([_, m]) => m.data.reduce((a, b) => a + b, 0));
        const colors = activeEntries.map(([_, m]) => m.borderColor);

        dataConfig = {
          labels: modelNames,
          datasets: [{
            data: totalScores,
            backgroundColor: colors,
            borderColor: isDark ? '#1e293b' : '#fff',
            borderWidth: 2
          }]
        };
        options.plugins.legend = { display: false };

      } else {
        if (chartType === 'horizontalBar') {
          chartType = 'bar';
          options.indexAxis = 'y';
        }

        const datasets = activeEntries.map(([_, model]) => ({
          label: model.label,
          data: model.data,
          fill: chartType === 'radar',
          backgroundColor: (chartType === 'bar' || chartType === 'polarArea') ? model.borderColor : model.color,
          borderColor: model.borderColor,
          pointBackgroundColor: isDark ? '#1e293b' : '#fff',
          pointBorderColor: model.borderColor,
          borderWidth: 2,
          pointRadius: 4,
          tension: 0.3
        }));

        dataConfig = {
          labels: LABELS,
          datasets: datasets
        };

        if (chartType === 'radar' || chartType === 'polarArea') {
          options.scales = {
            r: {
              angleLines: { color: gridColor },
              grid: { color: gridColor },
              pointLabels: {
                color: textColor,
                font: { size: 11, family: fontFamily, weight: '500' }
              },
              ticks: { display: false, backdropColor: 'transparent' },
              suggestedMin: 0,
              suggestedMax: 100
            }
          };
          if (chartType === 'radar') options.scales.r.suggestedMin = 0;
        } else {
          options.scales = {
            y: {
              beginAtZero: true,
              max: 100,
              grid: { color: gridColor },
              ticks: { color: textColor, font: { family: fontFamily } },
              border: { display: false }
            },
            x: {
              grid: { display: false },
              ticks: { color: textColor, font: { family: fontFamily } },
              border: { display: false }
            }
          };

          if (options.indexAxis === 'y') {
            options.scales.x.max = 100;
            options.scales.x.grid = { color: gridColor };
            options.scales.y.grid = { display: false };
            options.scales.y.max = undefined;
          }
        }
      }

      return {
        type: chartType,
        data: dataConfig,
        options: options
      };
    }

    function createChart() {
      if (myChart) {
        myChart.destroy();
        myChart = null;
      }
      gridCharts.forEach(c => c.destroy());
      gridCharts = [];

      const activeEntries = Object.entries(comparisonData).filter(([key]) => visibilityState[key]);

      if (currentChartType === 'polarArea') {
        // SPLIT VIEW: Left Big Chart, Right Small Grid

        // 1. Show Grid Container & Adjust Main Wrapper
        gridContainer.classList.remove('hidden');
        mainWrapper.classList.remove('w-full', 'md:w-full');
        mainWrapper.classList.add('w-full', 'md:w-1/2'); // Split 50/50 on desktop

        // 2. Render Main Chart (Superimposed) on Left
        // We need to ensure the canvas resizes correctly
        requestAnimationFrame(() => {
          myChart = new Chart(ctx, getChartConfig());
        });

        // 3. Render Small Grid Charts on Right
        gridContainer.innerHTML = '';
        activeEntries.forEach(([key, model]) => {
          const wrapper = document.createElement('div');
          wrapper.className = 'bg-gray-50 dark:bg-gray-800/50 rounded-lg p-2 border border-gray-100 dark:border-gray-700 flex flex-col h-40 relative'; // Smaller height

          const header = document.createElement('div');
          header.className = 'flex items-center gap-2 mb-1 z-10';
          header.innerHTML = `<span class="w-2 h-2 rounded-full" style="background-color: ${model.borderColor}"></span><span class="text-[10px] font-bold text-gray-700 dark:text-gray-300 truncate">${model.label}</span>`;
          wrapper.appendChild(header);

          const canvasContainer = document.createElement('div');
          canvasContainer.className = 'relative flex-grow w-full min-h-0';
          const canvas = document.createElement('canvas');
          canvasContainer.appendChild(canvas);
          wrapper.appendChild(canvasContainer);
          gridContainer.appendChild(wrapper);

          // Config for single model
          const config = getChartConfig([[key, model]]);
          config.options.plugins.legend = { display: false };
          config.options.maintainAspectRatio = false;
          // Simplify scales for small charts
          if (config.options.scales.r) {
            config.options.scales.r.ticks = { display: false };
            config.options.scales.r.pointLabels = { display: false }; // Hide labels on small charts to save space
          }

          gridCharts.push(new Chart(canvas, config));
        });

      } else {
        // NORMAL VIEW: Full Width Main Chart

        // 1. Hide Grid & Reset Main Wrapper
        gridContainer.classList.add('hidden');
        mainWrapper.classList.remove('w-full', 'md:w-1/2');
        mainWrapper.classList.add('w-full', 'md:w-full');

        requestAnimationFrame(() => {
          myChart = new Chart(ctx, getChartConfig());
        });
      }
    }

    const modal = document.getElementById('statsModal');

    function openModal() {
      modal.classList.remove('hidden');
      switchChartType('radar');
      renderLegend();
    }

    function closeModal() {
      modal.classList.add('hidden');
      if (myChart) {
        myChart.destroy();
        myChart = null;
      }
      gridCharts.forEach(c => c.destroy());
      gridCharts = [];
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
        closeModal();
      }
    });

    // --- NEW RENDERING LOGIC ---

    const uniqueRiddles = [
      { id: 'sound', question: "No tengo boca y hablo...", fullQ: "No tengo boca y hablo, no tengo oídos y escucho, no tengo cuerpo pero cobro vida con el aire. ¿Qué soy?", correct: "El Eco" },
      { id: 'water', question: "Me ves en el agua, pero nunca me mojo...", fullQ: "Me ves en el agua, pero nunca me mojo. ¿Qué soy?", correct: "El Reflejo" },
      { id: 'ascent', question: "¿Qué sube pero nunca baja?", fullQ: "¿Qué sube pero nunca baja?", correct: "La Edad" }
    ];

    function renderTestBench(modelKey) {
      const container = document.getElementById('riddles-container');
      const select = document.getElementById('modelSelect');

      if (!container || !select) return;

      // Populate Select if empty
      if (select.options.length === 0) {
        Object.entries(modelNames).forEach(([key, name]) => {
          const opt = document.createElement('option');
          opt.value = key;
          opt.text = name;
          select.appendChild(opt);
        });
        // Set initial value if provided or default
        if (modelKey) select.value = modelKey;
      }

      const currentModelKey = modelKey || select.value || Object.keys(modelNames)[0];
      const modelData = modelDetails[currentModelKey];

      if (!modelData) return;

      container.innerHTML = '';

      uniqueRiddles.forEach(riddle => {
        // Find matching riddle in modelData
        // We look for the question text in the 'acertijo' field
        const match = modelData.riddles.find(r => r.q.includes(riddle.question));

        if (match) {
          // Parse Answer from "Question... (Answer)"
          const answerMatch = match.q.match(/\((.*?)\)/);
          const modelAnswer = answerMatch ? answerMatch[1].trim() : "Respuesta implícita";
          const metrics = match.res.split('•').map(s => s.trim());

          const el = document.createElement('div');
          el.className = 'bg-gray-50 dark:bg-gray-800/50 rounded-lg border border-gray-100 dark:border-gray-700 overflow-hidden';
          el.innerHTML = `
                <div class="p-3 border-b border-gray-100 dark:border-gray-700 bg-gray-100/50 dark:bg-gray-700/30">
                    <h4 class="text-sm font-semibold text-gray-900 dark:text-white">${riddle.fullQ}</h4>
                </div>
                <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <p class="text-xs text-gray-500 uppercase tracking-wider mb-1">Respuesta del Modelo</p>
                        <p class="text-sm font-medium text-blue-600 dark:text-blue-400">"${modelAnswer}"</p>
                        <p class="text-xs text-gray-400 mt-1">Correcta: ${riddle.correct}</p>
                    </div>
                    <div class="flex flex-col justify-center gap-1 border-l border-gray-200 dark:border-gray-700 pl-4">
                         <div class="flex justify-between text-xs">
                            <span class="text-gray-500">Velocidad:</span>
                            <span class="font-mono text-gray-700 dark:text-gray-300">${metrics[0] || 'N/A'}</span>
                         </div>
                         <div class="flex justify-between text-xs">
                            <span class="text-gray-500">Tokens:</span>
                            <span class="font-mono text-gray-700 dark:text-gray-300">${metrics[1] || 'N/A'}</span>
                         </div>
                         <div class="flex justify-between text-xs">
                            <span class="text-gray-500">Latencia:</span>
                            <span class="font-mono text-gray-700 dark:text-gray-300">${metrics[2] || 'N/A'}</span>
                         </div>
                    </div>
                </div>
            `;
          container.appendChild(el);
        }
      });
    }

    // Initialize
    renderTestBench();
    console.log("Processed Data:", comparisonData);

  </script>
</body>

</html>